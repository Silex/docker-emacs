# requires /etc/sudoers with "gitlab-runner ALL=(ALL) NOPASSWD: /sbin/sysctl"
# requires ssh root@DOCKER_ARM_HOST working from the gitlab-runner account

image: docker:stable

variables:
  DOCKER_USER: silex
  DOCKER_CLI_EXPERIMENTAL: enabled
  DOCKER_PLATFORMS: linux/amd64,linux/386,linux/arm/v7,linux/arm64/v8

before_script:
  - sudo sysctl kernel.randomize_va_space=0
  - ssh root@$DOCKER_ARM_HOST sysctl kernel.randomize_va_space=0
  - docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD"
  - |
    if ! docker buildx inspect emacs-$CI_JOB_NAME; then
      docker buildx create --name emacs-$CI_JOB_NAME
      docker buildx create --append --name emacs-$CI_JOB_NAME ssh://root@$DOCKER_ARM_HOST
    fi
  - docker buildx inspect --bootstrap emacs-$CI_JOB_NAME
  - docker buildx use emacs-$CI_JOB_NAME

stages:
  - dev
  - std

template:
  stage: {{STAGE}}
  script: cd {{DIRECTORY}} && docker buildx build --platform $DOCKER_PLATFORMS --pull --push {{CACHE}}{{TAGS}} .
  needs: {{NEEDS}}
