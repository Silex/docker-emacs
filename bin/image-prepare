#!/usr/bin/env bash

set -e

if [ $# -lt 4 ]; then
  echo "usage: $0 REPOSITORY BRANCH GIT_DIRECTORY IMAGE_DIRECTORY" >&2
  exit 1
fi

repository="$1"
branch="$2"
git_directory="$3"
image_directory="$4"

git-sync "$repository" "$branch" "$git_directory"

# Copy updated sources to docker build context, and then remove
# the .git directory so it doesn't affect cache calculations
cp -rp "$git_directory" "$image_directory"
rm -rf "$image_directory/$branch/.git"
