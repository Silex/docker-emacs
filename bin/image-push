#!/usr/bin/env bash

set -e

if [ $# -lt 2 ]; then
  echo "usage: $0 REPOSITORY TAGS" >&2
  exit 1
fi

repository="$1"
tags="$2"

# DOCKER_USERNAME is empty for forked repositories
# TRAVIS_PULL_REQUEST is "true" for pull requests
# TRAVIS_BRANCH is the current branch or the PR target branch
# TRAVIS_PULL_REQUEST_BRANCH is the PR source branch
github_branch="${TRAVIS_PULL_REQUEST_BRANCH:-$TRAVIS_BRANCH}"
if [[ ! -z "$DOCKER_USERNAME" ]] && [[ "$TRAVIS_PULL_REQUEST" != "true" ]] && \
   [[ "$github_branch" == "master" ]] || [[ "$github_branch" == "staging-"* ]]; then
  docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
  for tag in $tags; do
    echo ">>> pushing $repository:$tag"
    docker push "$repository:$tag"
  done
else
  echo ">>> not pushing"
fi
