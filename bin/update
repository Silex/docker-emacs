#!/usr/bin/env ruby

require 'fileutils'

require 'yaml'
require 'ostruct'

class String
  def quotify
    format('"%s"', self)
  end

  def backquotify
    format('`%s`', self)
  end
end

class Image < OpenStruct
  def version
    case branch
    when /emacs-(\d+\.\d+)/
      $1
    else
      branch
    end
  end

  def directory
    File.join(version, template)
  end

  def dockerfile
    File.join(directory, 'Dockerfile')
  end

  def tags
    # Ensure tags are strings
    super.map(&:to_s)
  end
end

def update_dockerfiles(images)
  images.each do |image|
    directory = File.dirname(image.dockerfile)
    FileUtils.rm_rf(directory)
    FileUtils.mkdir_p(directory)
    content = File.read(format('templates/%s/Dockerfile', image.template))
    content.gsub!('{{BRANCH}}', image.branch)
    content.gsub!('{{VERSION}}', image.version.to_s)
    File.write(image.dockerfile, content)

    if image.patches
      patches_directory = format('%s/patches', directory)
      patches_files = Dir[format('templates/%s/*', image.patches)]
      FileUtils.mkdir_p(patches_directory)
      FileUtils.cp(patches_files, patches_directory)
    end
  end
end

def update_readme(images)
  tags = images.map do |image|
    format('- %s [(%s)](https://github.com/silex/docker-emacs/blob/master/%s)',
           image.tags.map(&:backquotify).join(', '),
           image.dockerfile,
           image.dockerfile)
  end.flatten
  content = File.read('templates/README.md')
  content.gsub!('{{TAGS}}', tags.join("\n"))
  File.write('README.md', content)
end

def update_travis(images)
  envs = images.map do |image|
    format('  - IMAGE_TAGS=%-35s IMAGE_DIRECTORY=%-35s GIT_BRANCH=%s',
           image.tags.join(' ').quotify,
           image.directory.quotify,
           image.branch.quotify)
  end
  content = File.read('templates/.travis.yml')
  content.gsub!('{{ENV}}', envs.join("\n"))
  File.write('.travis.yml', content)
end

Dir.chdir(File.join(File.dirname(__FILE__), '..'))
images = YAML.load_file('images.yml').map{ |h| Image.new(h) }

puts 'generating dockerfiles'
update_dockerfiles(images)
puts 'generating README.md'
update_readme(images)
puts 'generating .travis.yml'
update_travis(images)
