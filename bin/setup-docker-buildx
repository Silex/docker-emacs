#!/usr/bin/env bash

set -euo pipefail

function docker_architecture
{
  case "$(uname -m)" in
    aarch64)
      echo arm64
      ;;
    x86_64)
      echo amd64
      ;;
    *)
      ;;
  esac
}

if [[ $# -ne 1 ]]; then
  echo "usage: $0 VERSION" 1>&2
  exit 1
fi

BUILDX_VERSION="$1"
BUILDX_ARCH="$(docker_architecture)"
BUILDX_URL="https://github.com/docker/buildx/releases/download/v$BUILDX_VERSION/buildx-v$BUILDX_VERSION.linux-$BUILDX_ARCH"
BUILDX_PATH="$HOME/.docker/cli-plugins"

DOCKER_CLI_EXPERIMENTAL=enabled docker buildx version | grep $BUILDX_VERSION && exit 0 || true

mkdir -p "$BUILDX_PATH"
rm -rf "$BUILDX_PATH/docker-buildx"
wget -O "$BUILDX_PATH/docker-buildx" $BUILDX_URL
chmod a+x "$BUILDX_PATH/docker-buildx"
