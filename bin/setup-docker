#!/usr/bin/env bash

set -euo pipefail

# Ensure ASLR is disabled
sysctl kernel.randomize_va_space=0
ssh root@$DOCKER_ARM_HOST sysctl kernel.randomize_va_space=0

# Ensure buildx is at the correct version
setup-docker-buildx "$DOCKER_BUILDX_VERSION"
ssh root@$DOCKER_ARM_HOST "bash /dev/stdin $DOCKER_BUILDX_VERSION" < $(which setup-docker-buildx)

# Login to docker hub
docker login -u "$DOCKER_USER" -p "$DOCKER_PASSWORD"

# Remove old instances
docker buildx rm $DOCKER_BUILDX_BUILDER || true
ssh root@$DOCKER_ARM_HOST "docker container rm -vf \$(docker container ls -q --filter name=$DOCKER_BUILDX_BUILDER)" || true

# Create builder
docker buildx create --name $DOCKER_BUILDX_BUILDER
docker buildx create --append --name $DOCKER_BUILDX_BUILDER ssh://root@$DOCKER_ARM_HOST
docker buildx inspect --bootstrap $DOCKER_BUILDX_BUILDER
docker buildx use $DOCKER_BUILDX_BUILDER
